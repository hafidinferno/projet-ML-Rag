version: '3.8'

services:
 
  # ===========================================================================
  # Fraud Agent API
  # ===========================================================================
  
  fraud-agent-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fraud-agent-api
    ports:
      - "8001:8000"
    environment:
      
      # Ollama runs on the HOST (Windows/macOS). From container, use host.docker.internal
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=mistral

      # App paths inside container
      - DOCS_DIR=/app/data/docs
      - VECTORDB_DIR=/app/vectordb
      - LOGS_DIR=/app/logs

      # Persist HF cache to avoid huge re-downloads and "no space left"
      - HF_HOME=/app/.cache/huggingface
      - TRANSFORMERS_CACHE=/app/.cache/huggingface

    volumes:
      # Documents (read-only)
      - ./data/docs:/app/data/docs:ro

      # Persist vector database
      - ./vectordb:/app/vectordb

      # Persist logs
      - ./logs:/app/logs

      # Persist HuggingFace / sentence-transformers cache
      - ./hf_cache:/app/.cache/huggingface

      # Copy CLI script into container
      - ./chat_cli.py:/app/chat_cli.py

    restart: unless-stopped

    # Needed on Linux; safe to keep on Docker Desktop too
    extra_hosts:
      - "host.docker.internal:host-gateway"

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # n8n (Optional - can use external instance)
  # ===========================================================================
  n8n:
    image: n8nio/n8n:latest
    container_name: fraud-agent-n8n
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=changeme
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - WEBHOOK_URL=http://localhost:5678/
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped
    depends_on:
      - fraud-agent-api

volumes:
  n8n_data:


networks:
  default:
    name: fraud-agent-network